 {% extends "header_footer.html" %}
 {% load static %}

{% block title%}Auction Details{%endblock%}

    <!-- Start Auction Details section -->
{% block content %}

     <!-- Start Breadcrumb section -->
    <div class="breadcrumb-section seven" style="background-image:url({% static 'assets/img/inner-pages/breadcrumb-bg7.png' %});">  
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="banner-content">
                        <h1>Product Details</h1>    
                        <ul class="breadcrumb-list">
                            <li><a href="{% url 'home' %}">Home</a></li>
                            <li>Product Details</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- End Breadcrumb section -->
    <div class="auction-details-section pt-110 mb-110">
        <div class="container-fluid">
            <div class="row gy-5">
                <div class="col-xl-7">
                    <div class="auction-details-img">
                        <!-- Main Image Display Area (This part is correct) -->
                        <div class="tab-content" id="v-pills-tabContent">
                            <!-- Tab for Main Image -->
                            <div class="tab-pane fade show active" id="v-pills-img1" role="tabpanel" aria-labelledby="v-pills-img1-tab">
                                <div class="auction-details-tab-img">
                                    <img src="{{ product.main_image.url }}" alt="{{ product.product_name }}">
                                </div>
                            </div>

                            <!-- Loop through gallery paths for other tabs -->
                            {% for image_path in product.gallery_images %}
                                <div class="tab-pane fade" id="v-pills-img{{ forloop.counter|add:1 }}" role="tabpanel" aria-labelledby="v-pills-img{{ forloop.counter|add:1 }}-tab">
                                    <div class="auction-details-tab-img">
                                        <img src="{{ MEDIA_URL }}{{ image_path }}" alt="{{ product.product_name }} - Image {{ forloop.counter|add:1 }}">
                                    </div>
                                </div>
                            {% endfor %}
                        </div>

                        <!-- Thumbnail Navigation Slider -->
                        <!-- 
                            **FIX 1**: Added Bootstrap's 'nav' and 'nav-pills' classes to the main swiper container.
                            This tells Bootstrap that this entire block is a tab navigator.
                            **FIX 2**: Added an 'id' and 'role="tablist"' for accessibility and proper JS function.
                        -->
                        <div class="swiper auction-details-nav-slider nav nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                            <div class="swiper-wrapper">
                                
                                <!-- Thumbnail for Main Image -->
                                <div class="swiper-slide">
                                    <!-- 
                                        **FIX 3**: Added 'aria-controls' to explicitly link the button to its content pane.
                                    -->
                                    <button class="nav-link active" id="v-pills-img1-tab" data-bs-toggle="pill" data-bs-target="#v-pills-img1" type="button" role="tab" aria-controls="v-pills-img1" aria-selected="true">
                                        <img src="{{ product.main_image.url }}" alt="Thumbnail 1">
                                    </button>
                                </div>

                                <!-- Loop for gallery thumbnails -->
                                {% for image_path in product.gallery_images %}
                                    <div class="swiper-slide">
                                        <button class="nav-link" id="v-pills-img{{ forloop.counter|add:1 }}-tab" data-bs-toggle="pill" data-bs-target="#v-pills-img{{ forloop.counter|add:1 }}" type="button" role="tab" aria-controls="v-pills-img{{ forloop.counter|add:1 }}" aria-selected="false">
                                            <img src="{{ MEDIA_URL }}{{ image_path }}" alt="Thumbnail {{ forloop.counter|add:1 }}">
                                        </button>
                                    </div>
                                {% endfor %}

                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-5">
                    <div class="auction-details-content">
                        <div class="batch">
                            <span>Product Id :: {{product.id}}</span>
                        </div>
                        <h1>{{ product.product_name }}</h1>
                        <p>{{ product.sub_description }}</p>
                        <div class="price-area">
                            {% if product.auction_status == "live" %}
                                <span class="fs-5">Current Bid at ::</span>
                                <!-- Assuming you have a current_bid field, otherwise use start_price -->
                                <strong>‚Çπ{{ product.current_bid|default:product.start_price }}</strong>
                            {% elif product.auction_status == "closed"%}
                                {% if not highest_bid %}
                                    <strong class="text-danger">No buyer won this auction ‚Äî better luck next time!</strong>
                                {%else%}
                                <span class="fs-5 text-danger">Sold Out : :</span>
                                <!-- Assuming you have a current_bid field, otherwise use start_price -->
                                <strong class="text-danger">‚Çπ{{ product.current_bid|default:product.start_price }}</strong>
                                {%endif%}
                            {%else%}
                                <span class="fs-5" style="color:#00b4d8;">Start Bid at : :</span>
                                <!-- Assuming you have a current_bid field, otherwise use start_price -->
                                <strong style="color:#00b4d8;">‚Çπ{{ product.start_price|default:product.start_price }}</strong>
                            {%endif%}
                        </div>
                        <div class="mb-4">
                            <span class="fs-5"><strong>Starting On:</strong> {{ product.auction_start_date_time|date:"F d, Y, h:i A" }}</span>
                        </div>

                        <!-- Countdown Block -->
                        <div class="coundown-area">
                            <h6>Auction Will End In:</h6>
                            <div class="countdown-timer">
                                <!-- End time formatted for JavaScript -->
                                <ul data-countdown="{{ product.countdown_start|date:'Y-m-d H:i:s' }}">
                                    <li data-days="00">00 <span>Days</span> <span>Days</span></li>
                                    <li class="clone"><svg xmlns="http://www.w3.org/2000/svg" width="4" height="13" viewBox="0 0 4 13"><path d="M0 11.0633C0 11.5798 0.186992 12.0317 0.560976 12.419C0.95122 12.8063 1.43089 13 2 13C2.58537 13 3.06504 12.8063 3.43903 12.419C3.81301 12.0317 4 11.5798 4 11.0633C4 10.5146 3.81301 10.0546 3.43903 9.68343C3.06504 9.29609 2.58537 9.10242 2 9.10242C1.43089 9.10242 0.95122 9.29609 0.560976 9.68343C0.186992 10.0546 0 10.5146 0 11.0633ZM0 1.96089C0 2.49348 0.186992 2.95345 0.560976 3.34078C0.95122 3.72812 1.43089 3.92179 2 3.92179C2.58537 3.92179 3.06504 3.72812 3.43903 3.34078C3.81301 2.95345 4 2.49348 4 1.96089C4 1.42831 3.81301 0.968343 3.43903 0.581006C3.06504 0.193669 2.58537 0 2 0C1.43089 0 0.95122 0.193669 0.560976 0.581006C0.186992 0.968343 0 1.42831 0 1.96089Z"></path></svg></li>
                                    <li data-hours="00">00 <span>Hours</span> <span>Hours</span></li>
                                    <li class="clone"><svg xmlns="http://www.w3.org/2000/svg" width="4" height="13" viewBox="0 0 4 13"><path d="M0 11.0633C0 11.5798 0.186992 12.0317 0.560976 12.419C0.95122 12.8063 1.43089 13 2 13C2.58537 13 3.06504 12.8063 3.43903 12.419C3.81301 12.0317 4 11.5798 4 11.0633C4 10.5146 3.81301 10.0546 3.43903 9.68343C3.06504 9.29609 2.58537 9.10242 2 9.10242C1.43089 9.10242 0.95122 9.29609 0.560976 9.68343C0.186992 10.0546 0 10.5146 0 11.0633ZM0 1.96089C0 2.49348 0.186992 2.95345 0.560976 3.34078C0.95122 3.72812 1.43089 3.92179 2 3.92179C2.58537 3.92179 3.06504 3.72812 3.43903 3.34078C3.81301 2.95345 4 2.49348 4 1.96089C4 1.42831 3.81301 0.968343 3.43903 0.581006C3.06504 0.193669 2.58537 0 2 0C1.43089 0 0.95122 0.193669 0.560976 0.581006C0.186992 0.968343 0 1.42831 0 1.96089Z"></path></svg></li>
                                    <li data-minutes="00">00 <span>Mint</span> <span>Minutes</span></li>
                                    <li class="clone"><svg xmlns="http://www.w3.org/2000/svg" width="4" height="13" viewBox="0 0 4 13"><path d="M0 11.0633C0 11.5798 0.186992 12.0317 0.560976 12.419C0.95122 12.8063 1.43089 13 2 13C2.58537 13 3.06504 12.8063 3.43903 12.419C3.81301 12.0317 4 11.5798 4 11.0633C4 10.5146 3.81301 10.0546 3.43903 9.68343C3.06504 9.29609 2.58537 9.10242 2 9.10242C1.43089 9.10242 0.95122 9.29609 0.560976 9.68343C0.186992 10.0546 0 10.5146 0 11.0633ZM0 1.96089C0 2.49348 0.186992 2.95345 0.560976 3.34078C0.95122 3.72812 1.43089 3.92179 2 3.92179C2.58537 3.92179 3.06504 3.72812 3.43903 3.34078C3.81301 2.95345 4 2.49348 4 1.96089C4 1.42831 3.81301 0.968343 3.43903 0.581006C3.06504 0.193669 2.58537 0 2 0C1.43089 0 0.95122 0.193669 0.560976 0.581006C0.186992 0.968343 0 1.42831 0 1.96089Z"></path></svg></li>
                                    <li data-seconds="00">00 <span>Sec</span> <span>Seconds</span></li>
                                </ul>
                            </div>
                            
                            <!-- Ending On Block (Styled identically to "Starting On") -->
                            <div class="mt-4">
                                <span class="fs-5"><strong>Ending On:</strong> {{ product.auction_end_date_time|date:"F d, Y, h:i A" }}</span>
                            </div>
                        </div>
                            <div class="quantity-area">
                                {% if product.auction_status == "live"%}
                                    {% if user.is_authenticated and user.account_type == "Seller" %}
                                        <div class="alert alert-info mt-4">
                                            <strong>Note:</strong> Sellers cannot bid on their own or other products. Only bidders can place bids.
                                        </div>
                                    {% else %}
                                        <h6>Your Max Bid:</h6>
                                        <form method="POST" action="{% url 'place_bid' product.id %}">
                                        {% csrf_token %}
                                        <div class="quantity-counter-and-btn-area">
                                            <div class="quantity-counter d-flex align-items-center">
                                            <a class="quantity" id="btnMinus"><i class='bx bx-minus'></i></a>
                                            <input name="bid_amount" type="text" class="quantity__input text-center" id="bidInput" value="{{ product.current_bid|default:0 }}">
                                            <a class="quantity" id="btnPlus"><i class='bx bx-plus'></i></a>
                                            </div>

                                            <button type="submit" class="primary-btn btn-hover">
                                            Place Bid
                                            <span></span>
                                            </button>
                                        </div>
                                        </form>
                                    {% endif %}
                                {% endif %}
                            </div>  
                            {% if product.auction_status == "closed" %}
                                {% if highest_bid %}
                                    <div class="alert alert-success mt-4">
                                    üèÜ <strong>Winner:</strong> {{ winner.username }} <br>
                                    üí∞ <strong>Winning Bid:</strong> ‚Çπ{{ highest_bid.bid_amount }} <br>
                                    üïí <strong>Placed on:</strong> {{ highest_bid.bid_time|date:"M d, Y H:i" }}
                                    </div>
                                    {% if winner.username == user.username%}
                                        <p>absjchsab jbxiqwbi</p>
                                    {%endif%}
                                {% else %}
                                    <div class="alert alert-warning mt-4">
                                    No bids placed yet.
                                    </div>
                                {% endif %}
                            {%endif%}
                            <ul class="question-and-wishlist-area">
                            <li>
                                <a href="contact.html">
                                    <span>
                                        <svg width="11" height="11" viewBox="0 0 11 11" xmlns="http://www.w3.org/2000/svg">
                                            <g>
                                                <path
                                                d="M5.5 0C2.46015 0 0 2.45988 0 5.5C0 8.5398 2.45988 11 5.5 11C8.53985 11 11 8.54012 11 5.5C11 2.46015 8.54012 0 5.5 0ZM5.5 10.2326C2.89046 10.2326 0.767443 8.10956 0.767443 5.5C0.767443 2.89044 2.89046 0.767443 5.5 0.767443C8.10956 0.767443 10.2326 2.89044 10.2326 5.5C10.2326 8.10956 8.10956 10.2326 5.5 10.2326Z"/>
                                                <path
                                                d="M5.337 6.95948C5.03293 6.95948 4.78679 7.21287 4.78679 7.51692C4.78679 7.81377 5.02569 8.07439 5.337 8.07439C5.64831 8.07439 5.89443 7.81377 5.89443 7.51692C5.89443 7.21287 5.64105 6.95948 5.337 6.95948ZM5.4311 2.73877C4.45373 2.73877 4.00488 3.31797 4.00488 3.7089C4.00488 3.99124 4.24379 4.12157 4.43925 4.12157C4.83021 4.12157 4.67094 3.56409 5.40938 3.56409C5.77135 3.56409 6.06096 3.72338 6.06096 4.05641C6.06096 4.44734 5.65553 4.67176 5.41662 4.87447C5.20665 5.05543 4.93157 5.35228 4.93157 5.9749C4.93157 6.35135 5.03293 6.45995 5.32974 6.45995C5.68447 6.45995 5.75687 6.30069 5.75687 6.1631C5.75687 5.78665 5.76411 5.56947 6.1623 5.25816C6.35777 5.10613 6.97312 4.61382 6.97312 3.9333C6.97312 3.25278 6.35777 2.73877 5.4311 2.73877Z"/>
                                            </g>
                                        </svg>
                                    </span>
                                    Ask a question
                                </a>
                            </li>
                            <li>
                                <a class="wishlist-toggle-btn 
                                                    {% if product.id in user_wishlist_products %}active{% endif %}"
                                                        href="{% url 'toggle_wishlist' product.id %}"
                                                        aria-label="Toggle Wishlist">
                                    <span>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="12" fill="currentColor" class="bi bi-heart-fill" viewBox="0 0 16 16">
                                                    <path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314"/>
                                        </svg>
                                    </span>
                                    Add to wishlist
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div class="auction-details-description-area">
                        <div class="auction-details-description-nav mb-50">
                            <nav>
                                <div class="nav nav-tabs" id="nav-tab" role="tablist">
                                    <button class="nav-link active" id="nav-description-tab" data-bs-toggle="tab" data-bs-target="#nav-description" type="button" role="tab" aria-controls="nav-description" aria-selected="true">Description</button>
                                    <button class="nav-link" id="nav-reviews-tab" data-bs-toggle="tab" data-bs-target="#nav-reviews" type="button" role="tab" aria-controls="nav-reviews" aria-selected="false">Reviews</button>
                                </div>
                            </nav>
                        </div>
                        <div class="auction-details-description-tab">
                            <div class="tab-content" id="nav-tabContent">
                                <div class="tab-pane fade show active" id="nav-description" role="tabpanel" aria-labelledby="nav-description-tab">
                                    <div class="description-content">
                                    {{product.product_description}}
                                    </div>
                                </div>
                                
                                <div class="tab-pane fade" id="nav-reviews" role="tabpanel" aria-labelledby="nav-reviews-tab">
                                    <div class="reviews-area">
                                        <div class="number-of-review">
                                            <h4>Review ({{ reviews|length }}):</h4>
                                        </div>
                                      

                                        <div class="review-list-area mb-40">
                                            <ul class="comment">
                                                {% for review in reviews %}
                                                    
                                                    <li>
                                                        <div class="single-comment-area">
                                                            <div class="author-img">
                                                                {% if review.user.image %}
                                                                    <img src="{{ review.user.image.url }}" alt="{{ review.user.username }}">
                                                                {% endif %}
                                                            </div>
                                                            <div class="comment-content">
                                                                <div class="author-and-review">
                                                                    <div class="author-name-deg">
                                                                        <h6>{{ review.user.username }},</h6>
                                                                        <span>{{ review.created_at|date:"d F, Y" }}</span>
                                                                    </div>
                                                                     <ul class="review d-flex flex-row align-items-center">
                                                                        {# This is a nested loop to create the stars #}
                                                                        {% for i in "12345" %}
                                                                            <li>
                                                                                {% if forloop.counter <= review.rating %}
                                                                                    <i class="bi bi-star-fill"></i>
                                                                                {% else %}
                                                                                    <i class="bi bi-star"></i>
                                                                                {% endif %}
                                                                            </li>
                                                                        {% endfor %} {# This endfor correctly closes the star loop #}
                                                                    </ul>
                                                                </div>
                                                                <p>{{ review.message }}</p>
                                                            </div>
                                                        </div>
                                                    </li>

                                                {% empty %}

                                                    {# This part only shows if 'reviews' is empty #}
                                                    <li>
                                                        <div class="single-comment-area">
                                                            <p>There are no reviews for this product yet. Be the first to write one!</p>
                                                        </div>
                                                    </li>

                                                {% endfor %}
                                            </ul>
                                        </div>
                                        <div class="review-form">
                                            <div class="number-of-review">
                                                <h4>Write A Review</h4>
                                            </div>
                                             <form method="POST" action=""> <!-- Action can be empty to post to the same URL -->
                                                {% csrf_token %}
                                                <div class="row">
                                                    <div class="col-lg-12">
                                                        <div class="form-inner2 mb-40">
                                                            <div class="review-rate-area">
                                                                <p>Your Rating</p>
                                                                <!-- Display errors for the 'rating' field -->
                                                                {% if review_form.rating.errors %}
                                                                    <div class="alert alert-danger">
                                                                        {{ review_form.rating.errors }}
                                                                    </div>
                                                                {% endif %}
                                                                <div class="rate">
                                                                    <input type="radio" id="star5" name="rating" value="5" required>
                                                                    <label for="star5" title="text">5 stars</label>
                                                                    <input type="radio" id="star4" name="rating" value="4">
                                                                    <label for="star4" title="text">4 stars</label>
                                                                    <input type="radio" id="star3" name="rating" value="3">
                                                                    <label for="star3" title="text">3 stars</label>
                                                                    <input type="radio" id="star2" name="rating" value="2">
                                                                    <label for="star2" title="text">2 stars</label>
                                                                    <input type="radio" id="star1" name="rating" value="1">
                                                                    <label for="star1" title="text">1 star</label>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-12">
                                                        <div class="form-inner mb-30">
                                                            {{ review_form.message }}
                                                            {% if review_form.message.errors %}
                                                                <div class="alert alert-danger">{{ review_form.message.errors }}</div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-12">
                                                        <div class="form-inner two">
                                                            <button class="primary-btn btn-hover" type="submit">
                                                                Submit
                                                                <span></span>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container my-5">
                <h2 class="fw-bold mb-4">Bidding Summary</h2>
                    <div class="table-responsive shadow-sm">
                        <div class="rounded-top-3 overflow-hidden">
                            <table class="table align-middle mb-0">
                                <!-- Table Head -->
                                <thead class="bg-dark text-white">
                                    <tr>
                                        <th scope="col" class="p-3">Bidder</th>
                                        <th scope="col" class="p-3">Bid Amount (‚Çπ)</th>
                                        <th scope="col" class="p-3">Bid Time</th>
                                    </tr>
                                </thead>

                                <!-- Table Body -->
                                <tbody class="bg-white">
                                    {% for bid in bids %}
                                    <tr>
                                        <td>{{ bid.user.username }}</td>
                                        <td>{{ bid.bid_amount }}</td>
                                        <td>{{ bid.bid_time|date:"M d, Y H:i" }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="3" class="text-center">No bids yet.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="row pt-40">
                        <div class="col-lg-12">
                            <div class="inner-pagination-area two">
                                <ul class="paginations">
                                    <li class="page-item active">
                                        <a href="#">01</a>
                                    </li>
                                    <li class="page-item">
                                        <a href="#">02</a>
                                    </li>
                                    <li class="page-item">
                                        <a href="#">03</a>
                                    </li>
                                    <li class="page-item paginations-button">
                                        <a href="#">
                                            <svg width="16" height="13" viewBox="0 0 16 13" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M15.557 10.1026L1.34284 1.89603M15.557 10.1026C12.9386 8.59083 10.8853 3.68154 12.7282 0.489511M15.557 10.1026C12.9386 8.59083 7.66029 9.2674 5.81744 12.4593" stroke-width="0.96" stroke-linecap="round"></path>
                                            </svg>
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
            </div>
        </div>
    </div>
    {% endblock %}